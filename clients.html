<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <title>Clients ‚Äì Gestion</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

  <!-- NAVIGATION -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold">Gestion Clients</h1>
    <nav class="space-x-4 text-sm">
      <a href="index.html"     class="hover:text-blue-600">Accueil</a>
      <a href="clients.html"   class="text-blue-600 font-semibold">Clients</a>
      <a href="livraison.html" class="hover:text-blue-600">Livraisons</a>
      <a href="rapport.html"   class="hover:text-blue-600">Rapports</a>
    </nav>
  </header>

  <div class="flex-1 overflow-auto p-6 bg-white">
    <h2 class="text-xl font-semibold mb-4">Liste des Clients</h2>
    <table class="min-w-full text-sm border-collapse">
      <thead class="bg-gray-100">
        <tr>
          <th class="border p-2">Pr√©nom</th>
          <th class="border p-2">Nom</th>
          <th class="border p-2">Email</th>
          <th class="border p-2">T√©l</th>
          <th class="border p-2">Soci√©t√©</th>
          <th class="border p-2">Total Leads</th>
          <th class="border p-2">Leads par D√©partement</th>
          <th class="border p-2">Actions</th>
        </tr>
      </thead>
      <tbody id="clientsTableBody"></tbody>
    </table>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBOa5KcgBr7PkQKT6e_ftWORjbGzncY4Ck",
      authDomain: "lead-f9f71.firebaseapp.com",
      projectId: "lead-f9f71",
      storageBucket: "lead-f9f71.firebasestorage.app",
      messagingSenderId: "243276469711",
      appId: "1:243276469711:web:1aea9eba2a33e1c8026eba",
      measurementId: "G-BM1YRHR193"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function loadClientsWithCounts() {
      // 1) Charger clients
      const snapClients = await db.collection('clients').get();
      const clients = snapClients.docs.map(d => ({ id: d.id, ...d.data() }));

      // 2) Charger tous les leads
      const snapLeads = await db.collection('leads').get();
      const leads = snapLeads.docs.map(d => d.data());

      // 3) Agr√©ger par client
      const countsByClient = {};
      leads.forEach(({ clientId, department, quantity }) => {
        if (!countsByClient[clientId]) {
          countsByClient[clientId] = { total: 0, byDept: {} };
        }
        countsByClient[clientId].total += quantity;
        const bd = countsByClient[clientId].byDept;
        // on groupe aussi par d√©partement
        const dep = department || '‚Äî';
        bd[dep] = (bd[dep] || 0) + quantity;
      });

      // 4) Rendu tableau
      const tbody = document.getElementById('clientsTableBody');
      tbody.innerHTML = '';
      clients.forEach(c => {
        const cnt = countsByClient[c.id] || { total: 0, byDept: {} };
        const depts = Object.entries(cnt.byDept)
          .map(([d, q]) => `${d}: ${q}`)
          .join(', ');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border p-2">${c.firstName || ''}</td>
          <td class="border p-2">${c.lastName  || ''}</td>
          <td class="border p-2">${c.email     || ''}</td>
          <td class="border p-2">${c.phone     || ''}</td>
          <td class="border p-2">${c.company   || ''}</td>
          <td class="border p-2 text-right">${cnt.total}</td>
          <td class="border p-2">${depts}</td>
          <td class="border p-2 space-x-1">
            <button onclick="editClient('${c.id}')" class="text-yellow-500">‚úèÔ∏è</button>
            <button onclick="deleteClient('${c.id}')" class="text-red-500">üóëÔ∏è</button>
          </td>
        `;
        tbody.append(tr);
      });
    }

    // Placeholder functions for edit/delete (√† impl√©menter si besoin)
    window.editClient   = id => { alert('Modifier client ' + id); };
    window.deleteClient = id => {
      if (confirm('Supprimer ce client ?')) {
        db.collection('clients').doc(id).delete().then(loadClientsWithCounts);
      }
    };

    // Lancer
    loadClientsWithCounts();
  });
  </script>
</body>
</html>
