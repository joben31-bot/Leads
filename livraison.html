<!DOCTYPE html><html><head>
  <meta charset="UTF-8">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head><body class="p-4">

  <div class="flex gap-2 mb-4">
    <button id="prevWeek">←</button>
    <button id="nextWeek">→</button>
    <span id="weekLabel"></span>
    <button id="toggleView">Vue mensuelle</button>
    <input type="month" id="monthPicker">
  </div>

  <table class="table-fixed w-full border-collapse">
    <thead><tr id="hdr"></tr></thead>
    <tbody><tr id="weekRow"></tr></tbody>
  </table>

  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden">
    <div class="bg-white p-4 mx-auto mt-20 w-64">
      <h2 id="modalTitle"></h2>
      <select id="modalClient" class="w-full mb-2 border"></select>
      <input type="file" id="modalFile" class="w-full mb-2 border"/>
      <div class="flex justify-between">
        <button id="modalCancel">Annuler</button>
        <button id="modalSave">Importer</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

  // Firebase init
  firebase.initializeApp({ /* ta config */ });
  const db = firebase.firestore();

  // State + refs
  let currentMonday=new Date(), viewIsMonth=false;
  const weekRow=document.getElementById('weekRow');
  const weekLabel=document.getElementById('weekLabel');
  const hdr=document.getElementById('hdr');
  const prevWeek=document.getElementById('prevWeek');
  const nextWeek=document.getElementById('nextWeek');
  const toggleView=document.getElementById('toggleView');
  const monthPicker=document.getElementById('monthPicker');
  const modal=document.getElementById('modal');
  const modalTitle=document.getElementById('modalTitle');
  const modalClient=document.getElementById('modalClient');
  const modalFile=document.getElementById('modalFile');
  const modalSave=document.getElementById('modalSave');
  const modalCancel=document.getElementById('modalCancel');
  let clients=[], activeDate=null;

  function startOfWeek(d){
    const day=d.getDay(), diff=d.getDate()-day;
    return new Date(d.setDate(diff));
  }
  function fmt(d){ return d.toISOString().slice(0,10); }

  // Grid headers
  const days=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
  days.forEach(h=> hdr.append(Object.assign(document.createElement('th'),{
    className:'border p-2', textContent:h
  })));

  // Render week
  function renderWeek(){
    const mon = startOfWeek(new Date(currentMonday));
    weekLabel.textContent = `${fmt(mon)}`;
    weekRow.innerHTML='';
    for(let i=0;i<7;i++){
      const d=new Date(mon);
      d.setDate(mon.getDate()+i);
      const ds=fmt(d);
      const td=document.createElement('td');
      td.className='border h-24 p-1 cursor-pointer';
      td.dataset.date=ds;
      td.innerHTML=`
        <div class="font-semibold">${ds}</div>
        <div>&nbsp;</div>
      `;
      td.onclick=()=>openModal(ds);
      weekRow.append(td);
    }
  }

  // Modal open/close
  function openModal(dateKey){
    activeDate=dateKey;
    modalTitle.textContent=`Importer ${dateKey}`;
    modal.classList.remove('hidden');
  }
  modalCancel.onclick=()=>modal.classList.add('hidden');

  modalSave.onclick=async()=>{
    const cid=modalClient.value;
    const file=modalFile.files[0];
    if(!cid||!file){ return alert('Client+Fichier requis'); }
    const data=await file.arrayBuffer();
    const wb=XLSX.read(data);
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
    const qty=Math.max(0,rows.length-1);
    await db.collection('leads').add({clientId:cid,date:activeDate,quantity:qty});
    modal.classList.add('hidden');
  };

  // Load clients
  db.collection('clients').onSnapshot(snap=>{
    clients=snap.docs.map(d=>({id:d.id,...d.data()}));
    modalClient.innerHTML='';
    clients.forEach(c=>{
      modalClient.append(Object.assign(new Option(),{
        value:c.id, text:`${c.firstName} ${c.lastName}`
      }));
    });
  });

  // Navigation
  prevWeek.onclick=()=>{currentMonday.setDate(currentMonday.getDate()-7);renderWeek()};
  nextWeek.onclick=()=>{currentMonday.setDate(currentMonday.getDate()+7);renderWeek()};
  toggleView.onclick=()=>alert('La vue mensuelle n’est pas encore implémentée.');

  // Initial render
  renderWeek();

});
</script>
</body></html>
