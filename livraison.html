<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <title>Rapports – Gestion Leads</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

  <!-- NAVIGATION -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold">Rapports</h1>
    <nav class="space-x-4">
      <a href="index.html"     class="text-gray-600 hover:text-blue-600">Accueil</a>
      <a href="clients.html"   class="text-gray-600 hover:text-blue-600">Clients</a>
      <a href="livraison.html" class="text-gray-600 hover:text-blue-600">Livraisons</a>
      <a href="rapport.html"   class="text-blue-600 font-semibold">Rapports</a>
    </nav>
  </header>

  <!-- Contrôles de navigation de date -->
  <div class="p-4 bg-white flex items-center space-x-4">
    <button id="prevWeek" class="px-3 py-1 bg-gray-200 rounded">← Semaine précédente</button>
    <button id="nextWeek" class="px-3 py-1 bg-gray-200 rounded">Semaine suivante →</button>
    <span id="weekLabel" class="font-medium"></span>
    <input type="month" id="monthPicker" class="ml-auto border p-1 rounded"/>
  </div>

  <!-- Grille hebdo -->
  <div class="flex-1 overflow-auto p-4">
    <table class="w-full table-fixed border-collapse">
      <thead>
        <tr>
          <th class="border p-2">Dimanche</th>
          <th class="border p-2">Lundi</th>
          <th class="border p-2">Mardi</th>
          <th class="border p-2">Mercredi</th>
          <th class="border p-2">Jeudi</th>
          <th class="border p-2">Vendredi</th>
          <th class="border p-2">Samedi</th>
        </tr>
      </thead>
      <tbody>
        <tr id="weekRow">
          <!-- 7 cellules seront injectées ici -->
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    // --- 1) Init Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyBOa5KcgBr7PkQKT6e_ftWORjbGzncY4Ck",
      authDomain: "lead-f9f71.firebaseapp.com",
      projectId: "lead-f9f71",
      storageBucket: "lead-f9f71.firebasestorage.app",
      messagingSenderId: "243276469711",
      appId: "1:243276469711:web:1aea9eba2a33e1c8026eba",
      measurementId: "G-BM1YRHR193"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2) Prépare la grille hebdo ---
    const weekRow      = document.getElementById('weekRow');
    const weekLabel    = document.getElementById('weekLabel');
    const prevWeekBtn  = document.getElementById('prevWeek');
    const nextWeekBtn  = document.getElementById('nextWeek');
    const monthPicker  = document.getElementById('monthPicker');

    // Calcul d'un lundi donné
    function startOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay(); 
      const diff = d.getDate() - day; // dimanche=0, lundi=1
      return new Date(d.setDate(diff));
    }

    // Formate date display
    function fmt(d) {
      return d.toISOString().slice(0,10);
    }

    let currentMonday = startOfWeek(new Date());

    // Affiche la semaine et construit les cellules
    function renderWeek() {
      // monday
      const mon = currentMonday;
      // label
      const sun = new Date(mon);
      sun.setDate(mon.getDate() + 6);
      weekLabel.textContent = `${fmt(mon)} → ${fmt(sun)}`;

      // clear et créer 7 cellules
      weekRow.innerHTML = '';
      for (let i=0; i<7; i++) {
        const cellDate = new Date(mon);
        cellDate.setDate(mon.getDate() + i);
        const td = document.createElement('td');
        td.className = 'border align-top h-40 p-1 cursor-pointer';
        td.dataset.date = fmt(cellDate);
        // header date
        td.innerHTML = `<div class="font-semibold mb-1">${fmt(cellDate)}</div>`;
        // zone livraisons
        const ul = document.createElement('ul');
        ul.id = `day-${fmt(cellDate)}`;
        td.append(ul);
        // click pour ajouter
        td.addEventListener('click', () => addDelivery(cellDate));
        weekRow.append(td);
      }
      refreshDeliveries();
    }

    // navigation
    prevWeekBtn.onclick = () => { currentMonday.setDate(currentMonday.getDate()-7); renderWeek(); }
    nextWeekBtn.onclick = () => { currentMonday.setDate(currentMonday.getDate()+7); renderWeek(); }

    // vue mois (optionnelle : saute à la première semaine du mois)
    monthPicker.onchange = () => {
      const [y,m] = monthPicker.value.split('-').map(Number);
      currentMonday = startOfWeek(new Date(y, m-1, 1));
      renderWeek();
    };

    // --- 3) Gestion des livraisons ---
    // Liste clients pour prompt
    let clientsList = [];
    async function loadClientsList() {
      const snap = await db.collection('clients').get();
      clientsList = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    }

    // Ajout d’une livraison
    async function addDelivery(date) {
      await loadClientsList();
      // prompt choix client
      const labelClients = clientsList.map((c,i)=>`${i+1}. ${c.firstName} ${c.lastName}`).join('\n');
      const idx = parseInt(prompt(`Choisir un client (numéro)\n${labelClients}`),10) -1;
      if (idx<0 || idx>=clientsList.length) return alert('Client invalide');
      const qty = parseInt(prompt('Quantité de leads livrés :'),10);
      if (isNaN(qty) || qty<0) return alert('Quantité invalide');
      // date formatted
      const dstr = fmt(date);
      await db.collection('leads').add({
        clientId: clientsList[idx].id,
        date: dstr,
        quantity: qty
      });
    }

    // Affichage des livraisons
    async function refreshDeliveries() {
      // vide tous les ul
      weekRow.querySelectorAll('ul').forEach(ul=>ul.innerHTML='');
      // calc semaine
      const dates = [];
      for (let i=0;i<7;i++){
        const d=new Date(currentMonday);
        d.setDate(currentMonday.getDate()+i);
        dates.push(fmt(d));
      }
      // requête leads de la semaine
      const snap = await db.collection('leads')
        .where('date', 'in', dates).get();
      snap.docs.forEach(doc=>{
        const { clientId, quantity, date } = doc.data();
        const c = clientsList.find(x=>x.id===clientId);
        if (!c) return;
        const ul = document.getElementById(`day-${date}`);
        const li = document.createElement('li');
        li.textContent = `${c.firstName} ${c.lastName} : ${quantity}`;
        ul.append(li);
      });
    }

    // Rechargement temps réel
    db.collection('leads').onSnapshot(() => refreshDeliveries());

    // initialisation
    loadClientsList().then(renderWeek);
  </script>
</body>
</html>
