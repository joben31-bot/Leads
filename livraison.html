<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <title>Livraisons – Import Excel par département</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold">Agenda Livraisons</h1>
    <nav class="space-x-4 text-sm">
      <a href="index.html">Accueil</a>
      <a href="clients.html">Clients</a>
      <a href="livraison.html" class="text-blue-600 font-semibold">Livraisons</a>
      <a href="rapport.html">Rapports</a>
    </nav>
  </header>

  <div class="p-4 bg-white flex items-center space-x-4">
    <button id="prevWeek" class="px-3 py-1 bg-gray-200 rounded">← Sem préc.</button>
    <button id="nextWeek" class="px-3 py-1 bg-gray-200 rounded">Sem suiv. →</button>
    <span id="weekLabel" class="font-medium"></span>
  </div>

  <div class="flex-1 overflow-auto p-4 bg-white">
    <table class="w-full table-fixed border-collapse">
      <thead><tr id="headerRow"></tr></thead>
      <tbody><tr id="weekRow"></tr></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded shadow-lg w-80">
      <h2 class="text-lg font-semibold mb-4" id="modalTitle">Importer leads</h2>
      <div class="space-y-3">
        <label>Client
          <select id="modalClient" class="w-full border p-2 rounded"></select>
        </label>
        <label>Fichier Excel
          <input type="file" id="modalFile" accept=".xls,.xlsx" class="w-full border p-2 rounded"/>
        </label>
      </div>
      <div class="mt-4 flex justify-between items-center">
        <button id="modalDelete" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 hidden">
          Supprimer
        </button>
        <div class="flex gap-2">
          <button id="modalCancel" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Annuler</button>
          <button id="modalSave"   class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
            Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBOa5KcgBr7PkQKT6e_ftWORjbGzncY4Ck",
      authDomain: "lead-f9f71.firebaseapp.com",
      projectId: "lead-f9f71",
      storageBucket: "lead-f9f71.firebasestorage.app",
      messagingSenderId: "243276469711",
      appId: "1:243276469711:web:1aea9eba2a33e1c8026eba",
      measurementId: "G-BM1YRHR193"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM & state
    const headerRow     = document.getElementById('headerRow');
    const weekRow       = document.getElementById('weekRow');
    const weekLabel     = document.getElementById('weekLabel');
    const prevWeekBtn   = document.getElementById('prevWeek');
    const nextWeekBtn   = document.getElementById('nextWeek');
    const modalOverlay  = document.getElementById('modalOverlay');
    const modalTitle    = document.getElementById('modalTitle');
    const modalClient   = document.getElementById('modalClient');
    const modalFile     = document.getElementById('modalFile');
    const modalSaveBtn  = document.getElementById('modalSave');
    const modalCancelBtn= document.getElementById('modalCancel');
    const modalDeleteBtn= document.getElementById('modalDelete');

    let currentMonday = startOfWeek(new Date());
    let clients = [], deliveries = [];
    let editingId = null, editingDate = null;

    function startOfWeek(d) {
      const day = d.getDay(), diff = d.getDate() - day;
      return new Date(d.setDate(diff));
    }
    function fmt(d) {
      return d.toISOString().slice(0,10);
    }

    // Charger clients
    async function loadClients() {
      const snap = await db.collection('clients').get();
      clients = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      modalClient.innerHTML = '';
      clients.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.text  = `${c.firstName||''} ${c.lastName||''}`.trim();
        modalClient.append(opt);
      });
    }

    // Charger imports
    async function loadDeliveries() {
      const snap = await db.collection('leads').get();
      deliveries = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderWeek();
    }

    // Construire grille hebdo
    function renderWeek() {
      const mon = startOfWeek(new Date(currentMonday));
      const sun = new Date(mon); sun.setDate(mon.getDate()+6);
      weekLabel.textContent = `${fmt(mon)} → ${fmt(sun)}`;

      headerRow.innerHTML = '';
      ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam']
        .forEach(day => {
          const th = document.createElement('th');
          th.className='border p-2';
          th.textContent=day;
          headerRow.append(th);
        });

      weekRow.innerHTML = '';
      for(let i=0;i<7;i++){
        const d=new Date(mon); d.setDate(mon.getDate()+i);
        const ds=fmt(d);
        const td=document.createElement('td');
        td.className='border align-top h-32 p-1 cursor-pointer';
        td.dataset.date=ds;
        td.innerHTML=`<div class="font-semibold mb-1">${ds}</div><div>&nbsp;</div>`;
        td.onclick = ()=>openModal(ds);
        weekRow.append(td);
      }

      // afficher existants
      deliveries
        .filter(x => x.date>=fmt(mon) && x.date<=fmt(sun))
        .forEach(appendDelivery);
    }

    // Afficher un import
    function appendDelivery(entry) {
      const td = document.querySelector(`td[data-date="${entry.date}"]`);
      if(!td) return;
      const div=document.createElement('div');
      div.className='p-1 bg-gray-100 mb-1 cursor-pointer';
      const client=clients.find(c=>c.id===entry.clientId)||{};
      div.textContent=`${client.firstName||''} ${client.lastName||''}: ${entry.quantity} leads`;
      div.onclick=e=>{
        e.stopPropagation();
        openModal(entry.date, entry.id);
      };
      td.append(div);
    }

    // Navigation
    prevWeekBtn.onclick=()=>{ currentMonday.setDate(currentMonday.getDate()-7); renderWeek(); };
    nextWeekBtn.onclick=()=>{ currentMonday.setDate(currentMonday.getDate()+7); renderWeek(); };

    // Modal
    function openModal(date, id=null) {
      editingDate=date; editingId=id;
      modalTitle.textContent = id?`Modifier ${date}`:`Importer ${date}`;
      modalFile.value = null;
      modalDeleteBtn.classList.toggle('hidden', !id);
      modalOverlay.classList.remove('hidden');
    }
    modalCancelBtn.onclick = ()=>modalOverlay.classList.add('hidden');

    // Enregistrer import (par département)  
    modalSaveBtn.onclick = async () => {
      const cid  = modalClient.value;
      const file = modalFile.files[0];
      if(!cid)  return alert('Sélectionnez un client');
      if(!file) return alert('Choisissez un fichier Excel');

      // lire Excel
      const data = await file.arrayBuffer();
      const wb   = XLSX.read(data);
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

      // extraire code dept de chaque ligne
      const counts = {};
      rows.forEach(r => {
        const key = Object.keys(r)
          .find(k => k.toLowerCase().includes('dept'));
        const dep = r[key];
        if(dep) counts[dep] = (counts[dep]||0) + 1;
      });

      const batch = db.batch();
      // supprimer ancien s’il y a modif
      if(editingId) batch.delete(db.collection('leads').doc(editingId));

      // créer un doc par département
      Object.entries(counts).forEach(([dep,qty])=>{
        const ref = db.collection('leads').doc();
        batch.set(ref, {
          clientId: cid,
          date: editingDate,
          department: dep,
          quantity: qty
        });
      });

      await batch.commit();
      modalOverlay.classList.add('hidden');
    };

    // Supprimer import
    modalDeleteBtn.onclick = async () => {
      if(editingId && confirm('Supprimer cet import ?')) {
        await db.collection('leads').doc(editingId).delete();
        modalOverlay.classList.add('hidden');
      }
    };

    // démarrer
    loadClients().then(loadDeliveries);

  });
  </script>
</body>
</html>
