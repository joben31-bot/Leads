<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <title>Accueil – Gestion Leads</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin=""/>
</head>
<body class="flex flex-col h-screen">
  <div id="map" class="h-2/3 w-full"></div>
  <nav class="h-1/3 bg-gray-100 flex items-center justify-center space-x-4">
    <a href="clients.html" class="px-6 py-3 bg-blue-600 text-white rounded">Clients</a>
    <a href="livraison.html" class="px-6 py-3 bg-green-600 text-white rounded">Livraisons</a>
    <a href="rapport.html" class="px-6 py-3 bg-purple-600 text-white rounded">Rapports</a>
  </nav>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
          integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
          crossorigin=""></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBOa5KcgBr7PkQKT6e_ftWORjbGzncY4Ck",
      authDomain: "lead-f9f71.firebaseapp.com",
      projectId: "lead-f9f71",
      storageBucket: "lead-f9f71.firebasestorage.app",
      messagingSenderId: "243276469711",
      appId: "1:243276469711:web:1aea9eba2a33e1c8026eba",
      measurementId: "G-BM1YRHR193"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const departmentsList = [{"code": "01", "nom": "01"},{"code": "02", "nom": "02"},{"code": "03", "nom": "03"},{"code": "04", "nom": "04"},{"code": "05", "nom": "05"},{"code": "06", "nom": "06"},{"code": "07", "nom": "07"},{"code": "08", "nom": "08"},{"code": "09", "nom": "09"},{"code": "10", "nom": "10"},{"code": "11", "nom": "11"},{"code": "12", "nom": "12"},{"code": "13", "nom": "13"},{"code": "14", "nom": "14"},{"code": "15", "nom": "15"},{"code": "16", "nom": "16"},{"code": "17", "nom": "17"},{"code": "18", "nom": "18"},{"code": "19", "nom": "19"},{"code": "20", "nom": "20"},{"code": "21", "nom": "21"},{"code": "22", "nom": "22"},{"code": "23", "nom": "23"},{"code": "24", "nom": "24"},{"code": "25", "nom": "25"},{"code": "26", "nom": "26"},{"code": "27", "nom": "27"},{"code": "28", "nom": "28"},{"code": "29", "nom": "29"},{"code": "30", "nom": "30"},{"code": "31", "nom": "31"},{"code": "32", "nom": "32"},{"code": "33", "nom": "33"},{"code": "34", "nom": "34"},{"code": "35", "nom": "35"},{"code": "36", "nom": "36"},{"code": "37", "nom": "37"},{"code": "38", "nom": "38"},{"code": "39", "nom": "39"},{"code": "40", "nom": "40"},{"code": "41", "nom": "41"},{"code": "42", "nom": "42"},{"code": "43", "nom": "43"},{"code": "44", "nom": "44"},{"code": "45", "nom": "45"},{"code": "46", "nom": "46"},{"code": "47", "nom": "47"},{"code": "48", "nom": "48"},{"code": "49", "nom": "49"},{"code": "50", "nom": "50"},{"code": "51", "nom": "51"},{"code": "52", "nom": "52"},{"code": "53", "nom": "53"},{"code": "54", "nom": "54"},{"code": "55", "nom": "55"},{"code": "56", "nom": "56"},{"code": "57", "nom": "57"},{"code": "58", "nom": "58"},{"code": "59", "nom": "59"},{"code": "60", "nom": "60"},{"code": "61", "nom": "61"},{"code": "62", "nom": "62"},{"code": "63", "nom": "63"},{"code": "64", "nom": "64"},{"code": "65", "nom": "65"},{"code": "66", "nom": "66"},{"code": "67", "nom": "67"},{"code": "68", "nom": "68"},{"code": "69", "nom": "69"},{"code": "70", "nom": "70"},{"code": "71", "nom": "71"},{"code": "72", "nom": "72"},{"code": "73", "nom": "73"},{"code": "74", "nom": "74"},{"code": "75", "nom": "75"},{"code": "76", "nom": "76"},{"code": "77", "nom": "77"},{"code": "78", "nom": "78"},{"code": "79", "nom": "79"},{"code": "80", "nom": "80"},{"code": "81", "nom": "81"},{"code": "82", "nom": "82"},{"code": "83", "nom": "83"},{"code": "84", "nom": "84"},{"code": "85", "nom": "85"},{"code": "86", "nom": "86"},{"code": "87", "nom": "87"},{"code": "88", "nom": "88"},{"code": "89", "nom": "89"},{"code": "90", "nom": "90"},{"code": "91", "nom": "91"},{"code": "92", "nom": "92"},{"code": "93", "nom": "93"},{"code": "94", "nom": "94"},{"code": "95", "nom": "95"}];
    const map = L.map('map').setView([46.7,2.5],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'©OpenStreetMap'
    }).addTo(map);
    let layer;
    fetch('https://france-geojson.gregoiredavid.fr/repo/departements.geojson')
      .then(r=>r.json()).then(data=>{
        layer = L.geoJson(data, {
          style: f=>({fillColor:'white',weight:1,color:'gray',fillOpacity:0.7}),
          onEachFeature:(f,l)=>l.bindTooltip('')
        }).addTo(map);
        update();
      });
    function update(){
      if(!layer) return;
      db.collection('clients').get().then(snap=>{
        const clients = snap.docs.map(d=>d.data());
        layer.eachLayer(l=>{
          const code = l.feature.properties.code;
          const list = clients.filter(c=>c.departments?.includes(code))
                              .map(c=>c.firstName+' '+c.lastName);
          const n = list.length;
          const color = n===1?'green':n===2?'blue':n===3?'orange':n===4?'yellow':'white';
          l.setStyle({fillColor:color});
          l.setTooltipContent(list.length?list.join(', '):code);
        });
      });
    }
    db.collection('clients').onSnapshot(update);
  </script>
</body>
</html>